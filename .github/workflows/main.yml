name: Deploy to Cloudflare Workers

on:
      push:
            branches: [main] # Production deployments
      pull_request:
            branches: [main] # Preview deployments

jobs:
      deploy:
            runs-on: ubuntu-latest
            name: Deploy
            steps:
                  - uses: actions/checkout@v4
                    with:
                          fetch-depth: 0 # Fetch all history for git dates

                  - name: Setup Node.js
                    uses: actions/setup-node@v4
                    with:
                          node-version: 20
                          cache: "npm"

                  - name: Install dependencies
                    run: npm ci

                  - name: Build site
                    run: npm run build
                    env:
                          NODE_ENV: production

                  - name: Deploy to Cloudflare Workers
                    uses: cloudflare/wrangler-action@v3
                    with:
                          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
                          wranglerVersion: "4.27.0"
                          command: deploy
