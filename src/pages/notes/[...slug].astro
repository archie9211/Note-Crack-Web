---
import { getCollection, getEntryBySlug } from "astro:content";
import { getSubjects } from "../../content/config.mjs";
import ArticleLayout from "../../layouts/ArticleLayout.astro";
import ArticleNav from "../../components/ArticleNav.astro";
import TableOfContents from "../../components/TableOfContents.astro";
import MobileToggles from "../../components/MobileToggles.astro";
import PrevNextNav from "../../components/PrevNextNav.astro";
import ForceUpdateButton from "../../components/ForceUpdateButton.astro";
import MCQ from "../../components/MCQ.astro";
import ShowAllAnswers from "../../components/ShowAllAnswers.astro";

export async function getStaticPaths() {
      const subjects = getSubjects();
      const paths = [];
      for (const subject of subjects) {
            const entries = await getCollection(subject.name);
            for (const entry of entries) {
                  paths.push({ params: { slug: entry.slug } });
            }
      }
      return paths;
}

const { slug } = Astro.params;
if (!slug) return new Response("Not Found", { status: 404 });

const [subjectSlug, classSlug, ...topicParts] = slug.split("/");
const topicSlug = topicParts.join("/");

const entry = await getEntryBySlug(subjectSlug, slug);
if (!entry) return new Response("Article not found", { status: 404 });

const mcqs = entry.data.mcqs;

const { Content, headings } = await entry.render();
const allSubjects = getSubjects();
const hasHeadings = headings.length > 0;

// Get all topics in the current subject to find prev/next
const topicsInCurrentSubject = await getCollection(subjectSlug);
const currentIndex = topicsInCurrentSubject.findIndex(
      (topic) => topic.slug === slug
);

const prevTopic =
      currentIndex > 0 ? topicsInCurrentSubject[currentIndex - 1] : undefined;
const nextTopic =
      currentIndex < topicsInCurrentSubject.length - 1
            ? topicsInCurrentSubject[currentIndex + 1]
            : undefined;

const navProps = {
      allSubjects: allSubjects.map(s => s.name),
      currentSubject: subjectSlug,
      topicsInCurrentSubject: topicsInCurrentSubject.filter(e => e.slug.startsWith(classSlug)),
      currentTopicSlug: slug,
};
---

<ArticleLayout>
      <!-- Left Sidebar (Desktop) -->
      <div slot="left-sidebar">
            <ArticleNav {...navProps} />
      </div>

      <!-- ** NEW: Content for the slide-out mobile nav drawer ** -->
      <div slot="mobile-nav-drawer">
            <ArticleNav {...navProps} />
      </div>

      <!-- Main Content Area -->
      <div slot="main-content">
            <article class="prose prose-neutral dark:prose-invert max-w-none">
                  <div class="mb-8 text-center">
                        <p
                              class="text-sm font-semibold uppercase tracking-wider text-blue-600 dark:text-blue-400 capitalize"
                        >
                              {subjectSlug.replace("-", " ")}
                        </p>
                        <h1 class="text-4xl font-extrabold my-2">
                              {entry.data.title}
                        </h1>
                        <p class="text-lg text-gray-500 dark:text-gray-400">
                              {entry.data.description}
                        </p>
                  </div>
                  <hr class="my-8" />
                  <Content />
            </article>
            {
                  mcqs && mcqs.length > 0 && (
                        <section class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-800">
                              <h2 class="text-2xl font-bold mb-6">
                                    Test Your Knowledge
                              </h2>
                              {mcqs.map((question, index) => (
                                    <MCQ question={question} index={index} />
                              ))}
                              <ShowAllAnswers />
                        </section>
                  )
            }
            <PrevNextNav
                  prev={prevTopic && {
                        url: `/notes/${prevTopic.slug}`,
                        title: prevTopic.data.title,
                  }}
                  next={nextTopic && {
                        url: `/notes/${nextTopic.slug}`,
                        title: nextTopic.data.title,
                  }}
            />
            <ForceUpdateButton />
      </div>

      <!-- Right Sidebar (Desktop) -->
      <div slot="right-sidebar">
            {hasHeadings && <TableOfContents headings={headings} />}
      </div>

      <!-- Mobile Table of Contents (Drawer) -->
      <div slot="mobile-toc">
            {hasHeadings && <TableOfContents headings={headings} />}
      </div>

      <!-- Mobile Toggle Buttons: Show BOTH buttons -->
      <div slot="mobile-toggles">
            <MobileToggles showMenuToggle={true} showTocToggle={hasHeadings} />
      </div>
</ArticleLayout>
