---
import { getCollection } from "astro:content";
import ArticleLayout from "../layouts/ArticleLayout.astro";
import ArticleNav from "../components/ArticleNav.astro";
import MobileToggles from "../components/MobileToggles.astro";
import ForceUpdateButton from "../components/ForceUpdateButton.astro";
import { buildNavigationTree } from "../lib/navigation";

// NO getStaticPaths needed for SSR!

const { subject } = Astro.params;
if (!subject) return new Response("Not Found", { status: 404 });

// We still build the full tree for the sidebar navigation
const navTree = await buildNavigationTree();

const topicsByClass = navTree[subject] ?? {};

const navProps = {
      navTree: navTree,
      currentSubject: subject,
      currentTopicSlug: "", // No active topic on the subject page
};

const formatName = (slug: string) => slug.replace(/-/g, " ");
---

<ArticleLayout>
      <!-- Left Sidebar (Desktop) -->
      <div slot="left-sidebar">
            <ArticleNav {...navProps} />
      </div>

      <!-- Content for the slide-out mobile nav drawer -->
      <div slot="mobile-nav-drawer">
            <ArticleNav {...navProps} />
      </div>

      <!-- Main Content Area -->
      <div slot="main-content">
            <div
                  class="border-b border-gray-200 dark:border-gray-700 pb-3 mb-6"
            >
                  <h1 class="text-3xl lg:text-4xl font-bold capitalize">
                        {formatName(subject)} Notes
                  </h1>
            </div>

            <div class="space-y-10">
                  {
                        Object.entries(topicsByClass).map(
                              ([className, topics]) => (
                                    <section>
                                          <h2 class="text-2xl font-bold mb-4 capitalize border-b border-gray-200 dark:border-gray-700 pb-2">
                                                {formatName(className)}
                                          </h2>
                                          <ul class="space-y-4 list-none pl-0">
                                                {topics.map((entry) => (
                                                      <li>
                                                            <a
                                                                  href={`/notes/${subject}/${entry.slug}`}
                                                                  class="block p-4 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-all group hover:border-blue-500 dark:hover:border-blue-500"
                                                            >
                                                                  <h3 class="text-xl font-semibold text-blue-600 dark:text-blue-400 group-hover:underline">
                                                                        {
                                                                              entry.title
                                                                        }
                                                                  </h3>
                                                                  {/* Description might not be in the navTree, so this is optional */}
                                                            </a>
                                                      </li>
                                                ))}
                                          </ul>
                                    </section>
                              )
                        )
                  }
            </div>

            <ForceUpdateButton />
      </div>

      <!-- Mobile Toggle Buttons: Show ONLY the "Menu" button -->
      <div slot="mobile-toggles">
            <MobileToggles showMenuToggle={true} />
      </div>
</ArticleLayout>
